<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foods and Ingredients</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">

        <div class="navbar">
            <a href="{{ url_for('index') }}" class="btn-link">Homepage</a>
            <a href="{{ url_for('foods.all_foods') }}" class="btn-link">Foods & Ingredients</a>
            <a href="{{ url_for('profile') }}" class="btn-link">Profile</a>
            <a href="{{ url_for('foods.search_foods') }}" class="btn-link">Community Foods</a>
            <a href="{{ url_for('logout') }}" class="btn-link">Logout</a>
        </div>

        <h2>Foods and Ingredients</h2>

        {% for m in messages %}
        <p class="message">{{ m }}</p>
        {% endfor %}

        <!-- ===== Sorting & Search Form ===== -->
        <form method="get" class="sorting-form">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">

            <label for="search_input">Search:</label>
            <input type="text" id="search_input" name="search" value="{{ request.args.get('search', '') }}" 
            placeholder="Search foods or ingredients">

            <label for="ing_sort_by">Ingredient sort:</label>
            <select id="ing_sort_by" name="ing_sort_by">
                <option value="name" {% if ing_sort_by=='name' %}selected{% endif %}>Name</option>
                <option value="protein" {% if ing_sort_by=='protein' %}selected{% endif %}>Protein</option>
                <option value="calories" {% if ing_sort_by=='calories' %}selected{% endif %}>Calories</option>
            </select>
            <select name="ing_sort_dir">
                <option value="asc" {% if ing_sort_dir=='asc' %}selected{% endif %}>↑</option>
                <option value="desc" {% if ing_sort_dir=='desc' %}selected{% endif %}>↓</option>
            </select>

            <label for="food_sort_by">Food sort:</label>
            <select id="food_sort_by" name="food_sort_by">
                <option value="name" {% if food_sort_by=='name' %}selected{% endif %}>Name</option>
                <option value="class" {% if food_sort_by=='class' %}selected{% endif %}>Class</option>
                <option value="total_protein" {% if food_sort_by=='total_protein' %}selected{% endif %}>Total Protein</option>
                <option value="total_calories" {% if food_sort_by=='total_calories' %}selected{% endif %}>Total Calories</option>
            </select>
            <select name="food_sort_dir">
                <option value="asc" {% if food_sort_dir=='asc' %}selected{% endif %}>↑</option>
                <option value="desc" {% if food_sort_dir=='desc' %}selected{% endif %}>↓</option>
            </select>

            <button type="submit">Apply</button>
            <a href="{{ url_for('foods.all_foods') }}" class="btn-link">Reset</a>
        </form>

        <!-- ===== Existing Foods ===== -->
        <h3>Existing Foods</h3>
        <table class="foods-table">
            <tr>
                <th></th><th>Food Name</th><th>Meal Class</th><th>Ingredients</th>
                <th>Total Protein</th><th>Total Calories</th><th></th><th></th>
            </tr>
            {% for food in foods_list %}
            <tr>
                <td>
                    <form action="{{ url_for('foods.eat_food', food_id=food.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                        <button type="submit">Eat Food</button>
                    </form>
                </td>
                <td>{{ food.name }}</td>
                <td>{{ food.class }}</td>
                <td>
                    {% for ing in food.ingredients %}
                    {{ ing.quantity }} x {{ ing.name }}<br>
                    {% endfor %}
                </td>
                <td>{{ food.ingredients | sum_values(attribute='protein', quantity_attribute='quantity') }}</td>
                <td>{{ food.ingredients | sum_values(attribute='calories', quantity_attribute='quantity') }}</td>
                <td>
                    <form action="{{ url_for('foods.delete_food', food_id=food.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                        <button type="submit">Delete</button>
                    </form>
                </td>
                <td><a href="{{ url_for('foods.edit_food', food_id=food.id) }}" class="btn-link">Edit</a></td>
            </tr>
            {% endfor %}
        </table>

        <!-- ===== Add Food ===== -->
        <h3>Add Food</h3>
        <form action="{{ url_for('foods.add_food') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">

            <div>
                <label for="food_name_add">Food Name:</label>
                <input type="text" id="food_name_add" name="food_name" placeholder="Food Name" 
                maxlength="100" required class="big">

                <label for="food_class_add">Meal Class:</label>
                <select id="food_class_add" name="food_class" required class="med">
                    <option value="Breakfast/Supper">Breakfast/Supper</option>
                    <option value="Lunch/Dinner">Lunch/Dinner</option>
                    <option value="Snack">Snack</option>
                    <option value="Drink">Drink</option>
                </select>

                <label for="is_public">Public?</label>
                <input type="checkbox" id="is_public" name="is_public" checked>
            </div>

            <label>Ingredients (set quantity &gt;0 to include):</label>
            <div> 
                {% for ing in ingredients %}
                <div class="row">
                    <input type="number" id="ingredient_{{ ing.id }}" step="0.01" 
                    name="ingredient_{{ ing.id }}" min="0" max="10000" placeholder="0" class="mini">
                    <label for="ingredient_{{ ing.id }}">
                        {{ ing.name }} (Protein: {{ ing.protein }}, Calories: {{ ing.calories }})
                    </label>
                </div>
                {% endfor %}
            </div>

            <button type="submit" name="food_submit">Add Food</button>
        </form>

        <!-- ===== Existing Ingredients ===== -->
        <h3>Existing Ingredients</h3>
        <table>
            <tr><th>Name</th><th>Protein</th><th>Calories</th><th></th><th></th></tr>
            {% for ing in ingredients %}
            <tr>
                <td>{{ ing.name }}</td>
                <td>{{ ing.protein }}</td>
                <td>{{ ing.calories }}</td>
                <td>
                    <form action="{{ url_for('foods.delete_ingredient', ingredient_id=ing.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                        <button type="submit">Delete</button>
                    </form>
                </td>
                <td><a href="{{ url_for('foods.edit_ingredient', ingredient_id=ing.id) }}" class="btn-link">Edit</a></td>
            </tr>
            {% endfor %}
        </table>
        <p><em><small>Deleting an ingredient removes it from all foods</small></em></p>

        <!-- ===== Add Ingredient ===== -->
        <h3>Add Ingredient</h3>
        <form action="{{ url_for('foods.add_ingredient') }}" method="post" class="row">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
            
            <label for="ingredient_name">Ingredient Name:</label>
            <input type="text" id="ingredient_name" name="ingredient_name" 
            placeholder="Ingredient Name" maxlength="100" required>

            <label for="ingredient_protein">Protein (g):</label>
            <input type="number" id="ingredient_protein" step="0.01" name="ingredient_protein" 
            placeholder="Protein (g)" min="0" max="10000" required>

            <label for="ingredient_calories">Calories:</label>
            <input type="number" id="ingredient_calories" step="0.01" name="ingredient_calories" 
            placeholder="Calories" min="0" max="1000000" required>

            <button type="submit" name="ingredient_submit">Add Ingredient</button>
        </form>

        <!-- ===== Liked Foods ===== -->
        <h3>Your Liked Foods</h3>
        <table class="foods-table">
            <tr>
                <th></th><th>Food Name</th><th>Meal Class</th><th>Ingredients</th><th>Total Protein</th>
                <th>Total Calories</th><th></th>
            </tr>
            {% for food in liked_foods %}
            <tr>
                <td>
                    <form action="{{ url_for('foods.eat_food', food_id=food.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                        <button type="submit">Eat Food</button>
                    </form>
                </td>
                <td>{{ food.name }}</td>
                <td>{{ food.class }}</td>
                <td>
                    {% for ing in food.ingredients %}
                    {{ ing.quantity }} x {{ ing.name }}<br>
                    {% endfor %}
                </td>
                <td>{{ food.total_protein }}</td>
                <td>{{ food.total_calories }}</td>
                <td>
                    <form action="{{ url_for('foods.unlike_food', food_id=food.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                        <button type="submit">Unlike Food</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</body>
</html>

